<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Emitter 0.1a</title>
</head>
<script src='js/DAT.GUI.js'></script>
<script>
    var params = {
        gravity:1,
        attr:0.01,
        pressure: 1,
        xSpread: 0.001,
        ySpread: 0.001,
        zSpread: 0.001,
        opacity: 0.05
    };

    function loadGUI(){
        console.info("Loaded");
        var gui = new DAT.GUI({
            height: (Object.keys(params).length-1) * 32 - 1
        });
        var gravityCtrl = gui.add(params, 'gravity',0.01,3,0.01);
        var attrCtrl = gui.add(params, 'attr',0,0.1,0.001);
        var pressureCtrl = gui.add(params, 'pressure',0,2,0.01);
        var xSpreadCtrl = gui.add(params, 'xSpread',0,0.03,0.001);
        var ySpreadCtrl = gui.add(params, 'ySpread',0,0.03,0.001);
        var zSpreadCtrl = gui.add(params, 'zSpread',0,0.03,0.001);
        var opacityCtrl = gui.add(params, 'opacity',0,0.3,0.0001);


        gravityCtrl.onChange(function(value) {
            gravity = value;
        });

        attrCtrl.onChange(function(value) {
            attr = value;
        });

        pressureCtrl.onChange(function(value) {
            pressure = value;
        });

        xSpreadCtrl.onChange(function(value){
            xSpread = value;
        })

        ySpreadCtrl.onChange(function(value){
            ySpread = value;
        })

        zSpreadCtrl.onChange(function(value){
            zSpread = value;
        })

        opacityCtrl.onChange(function(value){
            opacity = value;
        })



    }
</script>
<script src="js/three.js"></script>
<script src="js/Mirror.js"></script>
<script src="js/WaterShaderNoSimplex.js"></script>
<script src="js/orbit.js"></script>
<script src="js/util.js"></script>
<script src="js/SimplexNoise.js"></script>
<script src="js/GPUComputationRenderer.js"></script>
<script id="smoothFragmentShader" type="x-shader/x-fragment">

			uniform sampler2D texture;
			void main()	{

				vec2 cellSize = 1.0 / resolution.xy;
				vec2 uv = gl_FragCoord.xy * cellSize;
				// Computes the mean of texel and 4 neighbours
				vec4 textureValue = texture2D( texture, uv );
				textureValue += texture2D( texture, uv + vec2( 0.0, cellSize.y ) );
				textureValue += texture2D( texture, uv + vec2( 0.0, - cellSize.y ) );
				textureValue += texture2D( texture, uv + vec2( cellSize.x, 0.0 ) );
				textureValue += texture2D( texture, uv + vec2( - cellSize.x, 0.0 ) );

				textureValue /= 5.0;

				gl_FragColor = textureValue;

			}
</script>
<script id="heightmapFragmentShader" type="x-shader/x-fragment">
			#include <common>
			uniform vec2 mousePos;
			float mouseSize = 10.0;
			uniform float viscosityConstant;
            float noise = 10.0;
			#define deltaTime ( 1.0 / 60.0 )
			#define GRAVITY_CONSTANT ( resolution.x * deltaTime * 10.0 )
			void main()	{
				vec2 cellSize = 1.0 / resolution.xy;
				vec2 uv = gl_FragCoord.xy * cellSize;
				vec4 heightmapValue = texture2D( heightmap, uv );
				vec4 north = texture2D( heightmap, uv + vec2( 0.0, cellSize.y ) );
				vec4 south = texture2D( heightmap, uv + vec2( 0.0, - cellSize.y ) );
				vec4 east = texture2D( heightmap, uv + vec2( cellSize.x, 0.0 ) );
				vec4 west = texture2D( heightmap, uv + vec2( - cellSize.x, 0.0 ) );
				float sump = north.x + south.x + east.x + west.x - 4.0 * heightmapValue.x;
				float accel = sump * GRAVITY_CONSTANT;
				heightmapValue.y += accel;
				heightmapValue.x += heightmapValue.y * deltaTime;
				heightmapValue.x += sump * viscosityConstant;
				// Mouse influence
				float mousePhase = clamp( length( ( uv - vec2( 0.5 ) ) * BOUNDS - vec2( mousePos.x, - mousePos.y ) ) * PI / mouseSize, 0.0, PI );
				heightmapValue.x += noise*cos( mousePhase ) + noise;
				gl_FragColor = heightmapValue;
			}
</script>
<script src="js/emitter.js"></script>

<style>
    * {
        margin:0;
    }
</style>
<body onload="start()">
</body>
</html>